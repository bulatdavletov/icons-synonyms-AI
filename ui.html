<html>
<head>
  <style>
    body {
      font-family: Inter, sans-serif;
      padding: 20px;
    }
    .container {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .title {
      font-weight: 500;
      margin: 0;
      color: #333;
    }
    .description {
      margin: 0;
      color: #666;
      font-size: 14px;
    }
    .type {
      font-size: 12px;
      color: #999;
    }
    .button {
      background: #18A0FB;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      width: 100%;
    }
    .button:disabled {
      background: #CCCCCC;
      cursor: not-allowed;
    }
    .section {
      margin-top: 10px;
    }
    .synonyms-container {
      margin-top: 16px;
      border: 1px solid #e5e5e5;
      border-radius: 6px;
      padding: 12px;
    }
    .synonyms-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .synonym-tag {
      background: #F0F0F0;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }
    .synonym-tag:hover {
      background: #E0E0E0;
    }
    .synonym-tag.selected {
      background: #D1E9FF;
    }
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin: 12px 0;
    }
    .spinner {
      border: 2px solid #f3f3f3;
      border-top: 2px solid #18A0FB;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error {
      color: #D32F2F;
      font-size: 14px;
      margin-top: 8px;
    }
    .result-box {
      margin-top: 12px;
      padding: 10px;
      border: 1px solid #e5e5e5;
      border-radius: 4px;
      max-height: 200px;
      overflow-y: auto;
    }
    .copy-button {
      margin-top: 8px;
      background: #F0F0F0;
      color: #333;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }
    .copy-button:hover {
      background: #E0E0E0;
    }
    .component-info {
      padding: 10px;
      background: #f8f8f8;
      border-radius: 6px;
      margin-bottom: 16px;
    }
    .actions-container {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }
    .apply-button {
      background: #4CAF50;
      flex: 1;
    }
    .select-all-button {
      background: #F0F0F0;
      color: #333;
      flex: 1;
    }
    .select-all-button:hover {
      background: #E0E0E0;
    }
    .selected-count {
      font-size: 12px;
      color: #666;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="component-info">
      <h3 class="title" id="name">Select a component</h3>
      <p class="type" id="type"></p>
      <p class="description" id="description">No component selected</p>
    </div>
    
    <div class="section">
      <button class="button" id="generateButton">Generate Synonyms</button>
      
      <div id="loadingSection" class="loading" style="display: none;">
        <div class="spinner"></div>
        <span>Generating synonyms...</span>
      </div>
      
      <div id="errorSection" class="error" style="display: none;"></div>
      
      <div id="synonymsSection" style="display: none;">
        <h4 class="title">Generated Synonyms</h4>
        <p class="description">Click on synonyms to select/deselect them</p>
        <div class="selected-count" id="selectedCount">0 synonyms selected</div>
        
        <!-- Synonyms List -->
        <div class="synonyms-container">
          <div class="synonyms-list" id="synonymsList"></div>
        </div>
        
        <!-- Preview Section -->
        <div id="previewSection" style="display: none;">
          <h4 class="title">Preview</h4>
          <textarea id="previewContent" class="result-box" style="width: 100%; min-height: 100px; resize: vertical; font-family: inherit; font-size: inherit;"></textarea>
        </div>
        
        <div class="actions-container">
          <button class="button select-all-button" id="selectAllButton">Select All</button>
          <button class="button apply-button" id="applyButton">Apply to Description</button>
        </div>
        
        <button class="copy-button" id="copyButton">Copy All to Clipboard</button>
      </div>
    </div>
  </div>
  <script>
    const generateButton = document.getElementById('generateButton');
    const loadingSection = document.getElementById('loadingSection');
    const errorSection = document.getElementById('errorSection');
    const synonymsSection = document.getElementById('synonymsSection');
    const synonymsList = document.getElementById('synonymsList');
    const copyButton = document.getElementById('copyButton');
    const selectAllButton = document.getElementById('selectAllButton');
    const applyButton = document.getElementById('applyButton');
    const selectedCount = document.getElementById('selectedCount');
    const previewSection = document.getElementById('previewSection');
    const previewContent = document.getElementById('previewContent');
    
    let currentNodeType = 'none';
    let generatedSynonyms = [];
    let selectedSynonyms = new Set();
    let currentDescription = '';
    let rawPreviewText = '';

    // Enable/disable generate button based on selection
    function updateButtonState() {
      // Enable generate button if we have a valid selection
      generateButton.disabled = (currentNodeType !== 'COMPONENT' && 
                               currentNodeType !== 'COMPONENT_SET' && 
                               currentNodeType !== 'INSTANCE');
    }
    
    // Update the selected count display
    function updateSelectedCount() {
      selectedCount.textContent = `${selectedSynonyms.size} synonyms selected`;
      updatePreview();
    }
    
    // Send a message to the plugin that the UI is ready
    window.onload = () => {
      console.log('UI is ready');
      parent.postMessage({ 
        pluginMessage: { 
          type: 'ui-ready'
        }
      }, '*');
    };

    // Create a synonym tag with selection functionality
    function createSynonymTag(synonym) {
      const tag = document.createElement('div');
      tag.className = 'synonym-tag';
      tag.textContent = synonym;
      
      // Add click handler for selection
      tag.addEventListener('click', () => {
        if (selectedSynonyms.has(synonym)) {
          selectedSynonyms.delete(synonym);
          tag.classList.remove('selected');
        } else {
          selectedSynonyms.add(synonym);
          tag.classList.add('selected');
        }
        updateSelectedCount();
      });
      
      return tag;
    }

    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      
      // Debug: Log the message received from the plugin
      console.log('Message received from plugin:', msg);
      
      if (msg.type === 'selection-change') {
        document.getElementById('name').textContent = msg.name || 'Select a component';
        document.getElementById('type').textContent = msg.type;
        
        // Update description display based on hasDescription flag
        const descriptionElement = document.getElementById('description');
        if (msg.hasDescription) {
          descriptionElement.textContent = msg.description;
        } else {
          if (msg.type === 'COMPONENT' || msg.type === 'COMPONENT_SET' || msg.type === 'INSTANCE') {
            descriptionElement.textContent = 'No description';
            descriptionElement.style.fontStyle = 'italic';
            descriptionElement.style.color = '#999';
          } else {
            descriptionElement.textContent = msg.description;
            descriptionElement.style.fontStyle = 'normal';
            descriptionElement.style.color = '#666';
          }
        }
        
        // Store the current description
        currentDescription = msg.description || '';
        
        // Update button state
        currentNodeType = msg.type;
        updateButtonState();
        
        // Hide synonyms section when selection changes
        synonymsSection.style.display = 'none';
        errorSection.style.display = 'none';
        
        // Clear selected synonyms
        selectedSynonyms.clear();
        updateSelectedCount();
      } else if (msg.type === 'synonyms-generated') {
        // Hide loading indicator
        loadingSection.style.display = 'none';
        
        if (msg.error) {
          // Show error message
          errorSection.textContent = msg.error;
          errorSection.style.display = 'block';
          synonymsSection.style.display = 'none';
        } else if (msg.synonyms && msg.synonyms.length > 0) {
          // Store the generated synonyms
          generatedSynonyms = msg.synonyms;
          
          // Clear previous synonyms and selected synonyms
          synonymsList.innerHTML = '';
          selectedSynonyms.clear();
          updateSelectedCount();
          
          // Add each synonym as a tag
          generatedSynonyms.forEach(synonym => {
            const tag = createSynonymTag(synonym);
            synonymsList.appendChild(tag);
          });
          
          // Show the synonyms section
          synonymsSection.style.display = 'block';
          errorSection.style.display = 'none';
        } else {
          // No synonyms generated
          errorSection.textContent = 'No synonyms were generated. Try again with a different icon.';
          errorSection.style.display = 'block';
          synonymsSection.style.display = 'none';
        }
      } else if (msg.type === 'description-updated') {
        // Update the displayed description
        const descriptionElement = document.getElementById('description');
        
        if (msg.hasDescription) {
          descriptionElement.textContent = msg.description;
          descriptionElement.style.fontStyle = 'normal';
          descriptionElement.style.color = '#666';
        } else {
          descriptionElement.textContent = 'No description';
          descriptionElement.style.fontStyle = 'italic';
          descriptionElement.style.color = '#999';
        }
        
        // Store the current description
        currentDescription = msg.description || '';
        
        // Show success message
        const successMessage = document.createElement('div');
        successMessage.textContent = 'Description updated successfully!';
        successMessage.style.color = '#4CAF50';
        successMessage.style.marginTop = '8px';
        successMessage.style.fontSize = '14px';
        
        // Add success message to the UI
        const actionsContainer = document.querySelector('.actions-container');
        actionsContainer.appendChild(successMessage);
        
        // Remove the message after 3 seconds
        setTimeout(() => {
          successMessage.remove();
        }, 3000);
      } else if (msg.type === 'generate-error') {
        // Hide loading indicator
        loadingSection.style.display = 'none';
        
        // Show error message
        errorSection.textContent = msg.error;
        errorSection.style.display = 'block';
        synonymsSection.style.display = 'none';
      }
    };
    
    // Handle generate button click
    generateButton.onclick = () => {
      // Show loading indicator
      loadingSection.style.display = 'flex';
      errorSection.style.display = 'none';
      synonymsSection.style.display = 'none';
      
      // Send message to plugin
      parent.postMessage({
        pluginMessage: {
          type: 'generate-synonyms'
        }
      }, '*');
    };
    
    // Handle select all button click
    selectAllButton.onclick = () => {
      if (generatedSynonyms.length === 0) {
        return;
      }
      
      // Check if all synonyms are already selected
      const allSelected = selectedSynonyms.size === generatedSynonyms.length;
      
      // Select or deselect all synonyms
      if (allSelected) {
        // Deselect all
        selectedSynonyms.clear();
        document.querySelectorAll('.synonym-tag').forEach(tag => {
          tag.classList.remove('selected');
        });
        selectAllButton.textContent = 'Select All';
      } else {
        // Select all
        generatedSynonyms.forEach(synonym => {
          selectedSynonyms.add(synonym);
        });
        document.querySelectorAll('.synonym-tag').forEach(tag => {
          tag.classList.add('selected');
        });
        selectAllButton.textContent = 'Deselect All';
      }
      
      updateSelectedCount();
    };
    
    // Handle apply button click
    applyButton.onclick = () => {
      if (selectedSynonyms.size === 0 && !rawPreviewText.trim()) {
        alert('Please select at least one synonym to apply');
        return;
      }
      
      // Get synonyms from the preview textarea, use raw text to preserve user edits
      const synonymsString = rawPreviewText || Array.from(selectedSynonyms).join(', ');
      
      if (!synonymsString.trim()) {
        alert('Preview content cannot be empty');
        return;
      }
      
      // Parse the synonyms
      const parsedSynonyms = synonymsString.split(',').map(s => s.trim()).filter(s => s);
      
      // Send message to update the description with the array of synonyms
      parent.postMessage({
        pluginMessage: {
          type: 'update-description',
          synonyms: parsedSynonyms
        }
      }, '*');
      
      // Reset the manually edited flag
      previewContent.dataset.manuallyEdited = false;
    };
    
    // Handle copy button click
    copyButton.onclick = () => {
      if (generatedSynonyms.length === 0) {
        return;
      }
      
      // Copy synonyms to clipboard
      const synonymsText = generatedSynonyms.join(', ');
      navigator.clipboard.writeText(synonymsText)
        .then(() => {
          copyButton.textContent = 'Copied!';
          setTimeout(() => {
            copyButton.textContent = 'Copy All to Clipboard';
          }, 2000);
        })
        .catch(err => {
          console.error('Failed to copy: ', err);
        });
    };

    // Functions to show or hide the preview section
    function showPreview() {
      if (selectedSynonyms.size > 0 || rawPreviewText.trim()) {
        previewSection.style.display = 'block';
      }
    }
    
    function hidePreview() {
      previewSection.style.display = 'none';
      rawPreviewText = '';
      previewContent.value = '';
      previewContent.dataset.manuallyEdited = false;
    }
    
    // Update the preview content
    function updatePreview() {
      if (selectedSynonyms.size > 0 || rawPreviewText.trim()) {
        // Only update the preview content if it hasn't been manually edited
        if (!previewContent.dataset.manuallyEdited) {
          rawPreviewText = Array.from(selectedSynonyms).join(', ');
          previewContent.value = rawPreviewText;
        }
        showPreview();
      } else {
        hidePreview();
      }
    }

    // Add event listener for preview content changes
    previewContent.addEventListener('input', () => {
      // Mark the content as manually edited
      previewContent.dataset.manuallyEdited = 'true';
      rawPreviewText = previewContent.value;
      
      // If the preview is empty, hide the preview section
      if (!rawPreviewText.trim() && selectedSynonyms.size === 0) {
        hidePreview();
      }
    });
  </script>
</body>
</html>
