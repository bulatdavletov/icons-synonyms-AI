<html>
<head>
  <style>
    body {
      font-family: Inter, sans-serif;
      padding: 20px;
      padding-bottom: 70px; /* Add padding at the bottom to make room for the fixed button */
      margin: 0;
      box-sizing: border-box;
    }
    .container {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .title {
      font-weight: 500;
      margin: 0;
      color: #333;
    }
    .description {
      margin: 0;
      color: #666;
      font-size: 14px;
    }
    .button {
      background: #18A0FB;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      width: 100%;
    }
    .button:disabled {
      background: #CCCCCC;
      cursor: not-allowed;
    }
    .section {
      margin-top: 10px;
    }
    .synonyms-container {
      margin-top: 16px;
      border: 1px solid #e5e5e5;
      border-radius: 6px;
      padding: 12px;
    }
    .synonyms-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .synonym-tag {
      background: #F0F0F0;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }
    .synonym-tag:hover {
      background: #E0E0E0;
    }
    .synonym-tag.selected {
      background: #D1E9FF;
    }
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin: 12px 0;
    }
    .spinner {
      border: 2px solid #f3f3f3;
      border-top: 2px solid #18A0FB;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error {
      color: #D32F2F;
      font-size: 14px;
      margin-top: 8px;
    }
    .result-box {
      margin-top: 12px;
      padding: 10px;
      border: 1px solid #e5e5e5;
      border-radius: 4px;
      max-height: 200px;
      overflow-y: auto;
    }
    .copy-button {
      margin-top: 8px;
      background: #F0F0F0;
      color: #333;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }
    .copy-button:hover {
      background: #E0E0E0;
    }
    .component-info {
      padding: 10px;
      background: #f8f8f8;
      border-radius: 6px;
      margin-bottom: 16px;
    }
    .actions-container {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }
    .apply-button {
      background: #4CAF50;
      flex: 1;
    }
    .select-all-button {
      background: #F0F0F0;
      color: #333;
      flex: 1;
    }
    .select-all-button:hover {
      background: #E0E0E0;
    }
    .selected-count {
      font-size: 12px;
      color: #666;
      margin-top: 8px;
    }
    /* Fixed bottom button style */
    .bottom-fixed {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      padding: 15px 20px;
      background: white;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      z-index: 100;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="component-info">
      <h3 class="title" id="name">Select a component</h3>
      <p class="description" id="description">No component selected</p>
      
      <div id="synonymsSection" style="display: none; margin-top: 16px;">
        <div class="selected-count" id="selectedCount">0 synonyms selected</div>
        
        <div class="synonyms-container">
          <div class="synonyms-list" id="synonymsList"></div>
        </div>
        
        <div id="previewSection" style="display: none;">
          <h4 class="title">Preview</h4>
          <textarea id="previewContent" class="result-box" style="width: 100%; min-height: 100px; resize: vertical; font-family: inherit; font-size: inherit;"></textarea>
        </div>
        
        <div class="actions-container">
          <button class="button select-all-button" id="selectAllButton">Select All</button>
          <button class="button apply-button" id="applyButton">Apply to Description</button>
        </div>
        
        <button class="copy-button" id="copyButton">Copy All to Clipboard</button>
      </div>
    </div>
    
    <div class="section">
      <div id="loadingSection" class="loading" style="display: none;">
        <div class="spinner"></div>
        <span>Generating synonyms...</span>
      </div>
      
      <div id="errorSection" class="error" style="display: none;"></div>
    </div>
  </div>
  
  <div class="bottom-fixed">
    <button class="button" id="generateButton">Generate Synonyms</button>
  </div>
  
  <script>
    const generateButton = document.getElementById('generateButton');
    const loadingSection = document.getElementById('loadingSection');
    const errorSection = document.getElementById('errorSection');
    const synonymsSection = document.getElementById('synonymsSection');
    const synonymsList = document.getElementById('synonymsList');
    const copyButton = document.getElementById('copyButton');
    const selectAllButton = document.getElementById('selectAllButton');
    const applyButton = document.getElementById('applyButton');
    const selectedCount = document.getElementById('selectedCount');
    const previewSection = document.getElementById('previewSection');
    const previewContent = document.getElementById('previewContent');
    
    let currentNodeType = 'none';
    let generatedSynonyms = [];
    let selectedSynonyms = new Set();
    let currentDescription = '';
    let rawPreviewText = '';

    function updateButtonState() {
      generateButton.disabled = (currentNodeType !== 'COMPONENT' && 
                               currentNodeType !== 'COMPONENT_SET' && 
                               currentNodeType !== 'INSTANCE');
    }
    
    function updateSelectedCount() {
      selectedCount.textContent = `${selectedSynonyms.size} synonyms selected`;
      updatePreview();
    }
    
    window.onload = () => {
      parent.postMessage({ 
        pluginMessage: { 
          type: 'ui-ready'
        }
      }, '*');
    };

    function createSynonymTag(synonym) {
      const tag = document.createElement('div');
      tag.className = 'synonym-tag';
      tag.textContent = synonym;
      
      tag.addEventListener('click', () => {
        if (selectedSynonyms.has(synonym)) {
          selectedSynonyms.delete(synonym);
          tag.classList.remove('selected');
        } else {
          selectedSynonyms.add(synonym);
          tag.classList.add('selected');
        }
        updateSelectedCount();
      });
      
      return tag;
    }

    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      
      console.log('Message received from plugin:', msg);
      
      if (msg.type === 'selection-change') {
        document.getElementById('name').textContent = msg.name || 'Select a component';
        
        const descriptionElement = document.getElementById('description');
        if (msg.hasDescription) {
          descriptionElement.textContent = msg.description;
        } else {
          if (msg.type === 'COMPONENT' || msg.type === 'COMPONENT_SET' || msg.type === 'INSTANCE') {
            descriptionElement.textContent = 'No description available. Generate synonyms to add a description.';
            descriptionElement.style.fontStyle = 'italic';
            descriptionElement.style.color = '#999';
          } else {
            descriptionElement.textContent = msg.description;
            descriptionElement.style.fontStyle = 'normal';
            descriptionElement.style.color = '#666';
          }
        }
        
        currentDescription = msg.description || '';
        
        // Store the node type but don't display it
        currentNodeType = msg.type;
        updateButtonState();
        
        synonymsSection.style.display = 'none';
        errorSection.style.display = 'none';
        
        selectedSynonyms.clear();
        updateSelectedCount();
      } else if (msg.type === 'synonyms-generated') {
        loadingSection.style.display = 'none';
        
        if (msg.error) {
          errorSection.textContent = msg.error;
          errorSection.style.display = 'block';
          synonymsSection.style.display = 'none';
        } else if (msg.synonyms && msg.synonyms.length > 0) {
          generatedSynonyms = msg.synonyms;
          
          synonymsList.innerHTML = '';
          selectedSynonyms.clear();
          updateSelectedCount();
          
          generatedSynonyms.forEach(synonym => {
            const tag = createSynonymTag(synonym);
            synonymsList.appendChild(tag);
          });
          
          synonymsSection.style.display = 'block';
          errorSection.style.display = 'none';
        } else {
          errorSection.textContent = 'No synonyms were generated. Try again with a different icon.';
          errorSection.style.display = 'block';
          synonymsSection.style.display = 'none';
        }
      } else if (msg.type === 'description-updated') {
        const descriptionElement = document.getElementById('description');
        
        if (msg.hasDescription) {
          descriptionElement.textContent = msg.description;
          descriptionElement.style.fontStyle = 'normal';
          descriptionElement.style.color = '#666';
        } else {
          descriptionElement.textContent = 'No description';
          descriptionElement.style.fontStyle = 'italic';
          descriptionElement.style.color = '#999';
        }
        
        currentDescription = msg.description || '';
        
        const successMessage = document.createElement('div');
        successMessage.textContent = 'Description updated successfully!';
        successMessage.style.color = '#4CAF50';
        successMessage.style.marginTop = '8px';
        successMessage.style.fontSize = '14px';
        
        const actionsContainer = document.querySelector('.actions-container');
        actionsContainer.appendChild(successMessage);
        
        setTimeout(() => {
          successMessage.remove();
        }, 3000);
      } else if (msg.type === 'generate-error') {
        loadingSection.style.display = 'none';
        
        errorSection.textContent = msg.error;
        errorSection.style.display = 'block';
        synonymsSection.style.display = 'none';
      }
    };
    
    generateButton.onclick = () => {
      loadingSection.style.display = 'flex';
      errorSection.style.display = 'none';
      synonymsSection.style.display = 'none';
      
      parent.postMessage({
        pluginMessage: {
          type: 'generate-synonyms'
        }
      }, '*');
    };
    
    selectAllButton.onclick = () => {
      if (generatedSynonyms.length === 0) {
        return;
      }
      
      const allSelected = selectedSynonyms.size === generatedSynonyms.length;
      
      if (allSelected) {
        selectedSynonyms.clear();
        document.querySelectorAll('.synonym-tag').forEach(tag => {
          tag.classList.remove('selected');
        });
        selectAllButton.textContent = 'Select All';
      } else {
        generatedSynonyms.forEach(synonym => {
          selectedSynonyms.add(synonym);
        });
        document.querySelectorAll('.synonym-tag').forEach(tag => {
          tag.classList.add('selected');
        });
        selectAllButton.textContent = 'Deselect All';
      }
      
      updateSelectedCount();
    };
    
    applyButton.onclick = () => {
      if (selectedSynonyms.size === 0 && !rawPreviewText.trim()) {
        alert('Please select at least one synonym to apply');
        return;
      }
      
      try {
        // Make sure we have valid data before joining
        const synonymsSet = selectedSynonyms || new Set();
        const synonymsString = rawPreviewText || 
          (synonymsSet.size > 0 ? Array.from(synonymsSet).join(', ') : '');
      
      if (!synonymsString.trim()) {
        alert('Preview content cannot be empty');
        return;
      }
      
      const parsedSynonyms = synonymsString.split(',').map(s => s.trim()).filter(s => s);
      
      parent.postMessage({
        pluginMessage: {
          type: 'update-description',
          synonyms: parsedSynonyms
        }
      }, '*');
      
      previewContent.dataset.manuallyEdited = false;
      } catch (error) {
        console.error('Error applying synonyms:', error);
        alert('An error occurred while applying synonyms. Please try again.');
      }
    };
    
    copyButton.onclick = () => {
      try {
        if (!generatedSynonyms || generatedSynonyms.length === 0) {
        return;
      }
      
        const synonymsText = Array.isArray(generatedSynonyms) ? generatedSynonyms.join(', ') : '';
      navigator.clipboard.writeText(synonymsText)
        .then(() => {
          copyButton.textContent = 'Copied!';
          setTimeout(() => {
            copyButton.textContent = 'Copy All to Clipboard';
          }, 2000);
        })
        .catch(err => {
          console.error('Failed to copy: ', err);
        });
      } catch (error) {
        console.error('Error copying synonyms:', error);
      }
    };

    function showPreview() {
      if (selectedSynonyms.size > 0 || rawPreviewText.trim()) {
        previewSection.style.display = 'block';
      }
    }
    
    function hidePreview() {
      previewSection.style.display = 'none';
      rawPreviewText = '';
      previewContent.value = '';
      previewContent.dataset.manuallyEdited = false;
    }
    
    function updatePreview() {
      try {
        if ((selectedSynonyms && selectedSynonyms.size > 0) || (rawPreviewText && rawPreviewText.trim())) {
        if (!previewContent.dataset.manuallyEdited) {
            const synonymsSet = selectedSynonyms || new Set();
            rawPreviewText = synonymsSet.size > 0 ? Array.from(synonymsSet).join(', ') : '';
            previewContent.value = rawPreviewText || '';
        }
        showPreview();
      } else {
        hidePreview();
        }
      } catch (error) {
        console.error('Error updating preview:', error);
      }
    }

    previewContent.addEventListener('input', () => {
      previewContent.dataset.manuallyEdited = 'true';
      rawPreviewText = previewContent.value;
      
      if (!rawPreviewText.trim() && selectedSynonyms.size === 0) {
        hidePreview();
      }
    });
  </script>
</body>
</html>
